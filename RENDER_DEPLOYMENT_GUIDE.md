# 🚀 Render Deployment Guide for BizBroker Backend

This guide will help you deploy your Node.js/Express backend API to Render.com.

## 📋 Prerequisites

1. **GitHub Repository**: Your code should be in a GitHub repository
2. **Render Account**: Sign up at [render.com](https://render.com)
3. **Environment Variables**: Gather all required environment variables (see below)

## 🔧 Required Environment Variables

Before deploying, you'll need to configure these environment variables in Render:

### Database Configuration
- `DATABASE_URL` - Will be automatically provided by Render PostgreSQL service

### Authentication & Security
- `JWT_SECRET` - Will be auto-generated by Render
- `NODE_ENV=production` - Set automatically

### Email Configuration (IMAP/SMTP)
- `EMAIL_USERNAME` - Your email address for sending/receiving emails
- `EMAIL_PASSWORD` - Your email app password (not regular password)

### File Upload (Cloudinary)
- `CLOUDINARY_CLOUD_NAME` - Your Cloudinary cloud name
- `CLOUDINARY_API_KEY` - Your Cloudinary API key
- `CLOUDINARY_API_SECRET` - Your Cloudinary API secret

### Payment Processing (Stripe)
- `STRIPE_SECRET_KEY` - Your Stripe secret key (starts with `sk_`)
- `STRIPE_WEBHOOK_SECRET` - Your Stripe webhook secret (starts with `whsec_`)

### Authentication Provider (Auth0) - Optional
- `AUTH0_DOMAIN` - Your Auth0 domain
- `AUTH0_CLIENT_ID` - Your Auth0 client ID
- `AUTH0_CLIENT_SECRET` - Your Auth0 client secret

## 🗄️ Database Setup

### Step 1: Create PostgreSQL Database on Render

1. Log into your Render dashboard
2. Click **"New +"** → **"PostgreSQL"**
3. Configure your database:
   - **Name**: `bizbroker-db`
   - **Database**: `bizbroker`
   - **User**: `bizbroker_user`
   - **Plan**: Choose **Starter** (free tier) or higher
4. Click **"Create Database"**
5. Wait for the database to be created
6. Copy the **External Database URL** - you'll need this

## 🚀 Web Service Deployment

### Step 2: Deploy Your Backend Service

1. In your Render dashboard, click **"New +"** → **"Web Service"**
2. Connect your GitHub repository
3. Configure your service:

#### Basic Settings
- **Name**: `bizbroker-backend`
- **Environment**: `Node`
- **Region**: Choose closest to your users
- **Branch**: `main` (or your default branch)
- **Root Directory**: Leave empty (root of repo)

#### Build & Deploy Settings
- **Build Command**: `npm install && npx prisma generate && npx prisma migrate deploy`
- **Start Command**: `npm start`
- **Plan**: Choose **Starter** (free tier) or higher

#### Environment Variables
Add all the environment variables listed above. For sensitive values:
- Click **"Add Environment Variable"**
- Enter the key and value
- Mark as **"Secret"** for sensitive data

#### Advanced Settings
- **Health Check Path**: `/health`
- **Auto-Deploy**: `Yes` (recommended)

### Step 3: Connect Database to Service

1. In your web service settings, go to **"Environment"**
2. Add environment variable:
   - **Key**: `DATABASE_URL`
   - **Value**: Copy the **Internal Database URL** from your PostgreSQL service
   - **Type**: Secret

## 🔄 Deployment Process

Once you click **"Create Web Service"**, Render will:

1. **Clone** your repository
2. **Install** dependencies (`npm install`)
3. **Generate** Prisma client (`npx prisma generate`)
4. **Run** database migrations (`npx prisma migrate deploy`)
5. **Start** your application (`npm start`)

## ✅ Post-Deployment Verification

### 1. Check Service Health
Visit your service URL + `/health`:
```
https://your-service-name.onrender.com/health
```

Expected response:
```json
{
  "status": "healthy",
  "timestamp": "2024-01-01T00:00:00.000Z",
  "services": {
    "database": "connected",
    "email_sending": "configured",
    "email_receiving": "active",
    "email_reconnect_attempts": 0
  },
  "version": "1.0.0"
}
```

### 2. Test API Endpoints
Test your main endpoints:
- `GET /` - API welcome message
- `GET /test` - Basic connectivity test
- `GET /api/email/status` - Email service status

### 3. Check Logs
In Render dashboard:
1. Go to your service
2. Click **"Logs"** tab
3. Look for any errors or warnings
4. Verify Prisma migrations ran successfully

## 🔧 Troubleshooting

### Common Issues

#### 1. Database Connection Failed
- **Check**: `DATABASE_URL` is correctly set
- **Verify**: Database service is running
- **Solution**: Use Internal Database URL, not External

#### 2. Prisma Migration Failed
- **Check**: Database permissions
- **Verify**: Migration files are in `prisma/migrations/`
- **Solution**: Run `npx prisma migrate reset` locally first

#### 3. Email Service Not Starting
- **Check**: `EMAIL_USERNAME` and `EMAIL_PASSWORD` are set
- **Verify**: Email credentials are correct
- **Solution**: Use app passwords, not regular passwords

#### 4. Build Command Failed
- **Check**: All dependencies are in `package.json`
- **Verify**: Node.js version compatibility
- **Solution**: Add `"engines": {"node": ">=18.0.0"}` to package.json

### Performance Optimization

#### 1. Enable Caching
Add to your service settings:
- **Environment Variable**: `NODE_ENV=production`

#### 2. Database Connection Pooling
Your Prisma setup already includes connection pooling.

#### 3. Static File Serving
If serving static files, consider using a CDN.

## 🔄 Continuous Deployment

### Automatic Deployments
- Render automatically deploys when you push to your main branch
- Each deployment gets a unique URL for testing
- Production URL remains stable

### Manual Deployments
- Go to your service dashboard
- Click **"Manual Deploy"**
- Choose branch or commit to deploy

## 📊 Monitoring & Maintenance

### 1. Service Monitoring
- **Uptime**: Check service status in dashboard
- **Performance**: Monitor response times
- **Logs**: Review logs regularly for errors

### 2. Database Maintenance
- **Backups**: Render handles automatic backups
- **Scaling**: Upgrade plan as needed
- **Monitoring**: Check database metrics

### 3. Security Updates
- **Dependencies**: Keep npm packages updated
- **Environment**: Rotate secrets regularly
- **Access**: Limit dashboard access

## 🎯 Next Steps

1. **Domain Setup**: Configure custom domain if needed
2. **SSL Certificate**: Automatically provided by Render
3. **Monitoring**: Set up external monitoring (optional)
4. **Scaling**: Upgrade plans as traffic grows

## 📞 Support

- **Render Documentation**: [render.com/docs](https://render.com/docs)
- **Render Support**: Available in dashboard
- **Community**: Render Discord/Forums

---

**🎉 Congratulations!** Your BizBroker backend is now deployed on Render!

